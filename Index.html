<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <style>
      #chat-container {
        height: 400px;
        overflow-y: scroll;
        border: 1px solid #ccc;
        padding: 10px;
        margin-bottom: 10px;
      }
      .message {
        margin-bottom: 10px;
      }
      #drive-results {
        margin-top: 20px;
        border-top: 1px solid #ccc;
        padding-top: 10px;
      }
    </style>
  </head>
  <body>
    <h1>COI Compass</h1>
    <div id="country-selection">
      <button onclick="selectCountry('Uganda')">Uganda</button>
      <button onclick="selectCountry('Sri Lanka')">Sri Lanka</button>
      <button onclick="selectCountry('Nigeria')">Nigeria</button>
    </div>
    <div id="chat-interface" style="display:none;">
      <div id="chat-container"></div>
      <input type="text" id="user-input" placeholder="質問を入力してください">
      <button onclick="sendMessage()">送信</button>
    </div>
    <div id="drive-results"></div>
    
    <script>
      var selectedCountry = '';
      
      function selectCountry(country) {
        selectedCountry = country;
        document.getElementById('country-selection').style.display = 'none';
        document.getElementById('chat-interface').style.display = 'block';
      }
      
      function sendMessage() {
        var userInput = document.getElementById('user-input');
        var message = userInput.value;
        if (message.trim() === '') return;
        
        addMessageToChat('user', message);
        userInput.value = '';
        
        google.script.run.withSuccessHandler(handleResponse).handleUserInput(selectedCountry, message);
      }
      
      function handleResponse(result) {
        addMessageToChat('bot', result.difyResponse);
        displayDriveResults(result.driveResults);
      }
      
      function addMessageToChat(sender, message) {
        var chatContainer = document.getElementById('chat-container');
        var messageElement = document.createElement('div');
        messageElement.className = 'message ' + sender + '-message';
        messageElement.textContent = sender === 'user' ? 'あなた: ' + message : 'COI Compass: ' + message;
        chatContainer.appendChild(messageElement);
        chatContainer.scrollTop = chatContainer.scrollHeight;
      }
      
      function displayDriveResults(results) {
        var container = document.getElementById('drive-results');
        container.innerHTML = '<h3>関連する文書:</h3>';
        
        if (results.length === 0) {
          container.innerHTML += '<p>関連する文書は見つかりませんでした。</p>';
          return;
        }
        
        results.forEach(function(file) {
          container.innerHTML += `
            <div>
              <strong>${file.name}</strong><br>
              <a href="${file.url}" target="_blank">ドキュメントを開く</a><br>
              <em>${file.snippet}</em>
            </div>
            <hr>
          `;
        });
      }
    </script>
  </body>
</html>