<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>COI Compass</title>
  <base target="_top">
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      line-height: 1.6;
      color: #333;
      background-color: #f0f0f0;
      height: 100vh;
      overflow: hidden;
      font-size: 36px;
      padding-top: 120px;
    }

    header {
      background-color: #ffffff;
      padding: 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 1000;
      height: 120px;
    }

    .logo {
      height: 100px;
    }

    .hamburger {
      font-size: 54px;
      background: none;
      border: none;
      cursor: pointer;
      padding: 10px 15px;
    }

     .home-icon {
    background: none;
    border: none;
    cursor: pointer;
    padding: 10px 15px;
  }

  .home-icon svg {
    width: 54px;
    height: 54px;
    stroke: #000000; /* アイコンの色 */
  }

  .home-icon:hover svg {
    opacity: 0.7;
  }

    #chat-container {
      height: calc(100vh - 300px);
      overflow-y: auto;
      padding: 20px;
      padding-bottom: 180px;
      background-color: #f0f0f0;
      display: flex;
      flex-direction: column;
      -webkit-overflow-scrolling: touch;
    }

    .message {
      max-width: 80%;
      margin-bottom: 20px;
      padding: 15px 20px;
      border-radius: 25px;
      clear: both;
      word-wrap: break-word;
      font-size: 36px;
      line-height: 1.4;
    }

    .user-message {
      background-color: #dcf8c6;
      align-self: flex-end;
      border-bottom-right-radius: 10px;
    }

    .bot-message {
      background-color: #ffffff;
      align-self: flex-start;
      border-bottom-left-radius: 10px;
    }

    #welcome-message {
      text-align: center;
      margin: 20px 0;
      font-size: 44px;
      font-weight: bold;
      color: #4a4a4a;
    }

    #country-selection, #uganda-options, #topic-options {
      display: flex;
      flex-direction: column;
      gap: 20px;
      width: 50%;
      margin: 20px auto 0;
      padding: 0 20px;
    }

    #country-selection button, #uganda-options button, #topic-options button {
      width: 100%;
      padding: 20px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 15px;
      cursor: pointer;
      transition: background-color 0.3s, transform 0.1s;
      font-size: 40px;
      font-weight: bold;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }

    #country-selection button:hover, #uganda-options button:hover, #topic-options button:hover {
      background-color: #45a049;
      transform: scale(1.02);
    }

    #input-area {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background-color: #ffffff;
      padding: 15px;
      display: flex;
      align-items: center;
      box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.1);
      height: 180px;
    }

    #user-input {
      flex: 1;
      padding: 30px 20px;
      border: 3px solid #000080;
      border-radius: 40px;
      font-size: 48px;
      outline: none;
      margin-right: 10px;
    }

    #send-button {
      width: 130px;
      height: 100px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 50px;
      cursor: pointer;
      font-size: 48px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #drive-results {
      display: none;
      position: fixed;
      top: 90px;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ffffff;
      padding: 20px;
      overflow-y: auto;
      z-index: 2000;
      font-size: 36px;
    }

    #drive-results h3 {
      margin-bottom: 20px;
      font-size: 40px;
    }

    #drive-results div {
      margin-bottom: 30px;
    }

    #drive-results a {
      color: #4CAF50;
      text-decoration: none;
      font-size: 36px;
    }

    #drive-results em {
      font-style: italic;
      color: #666;
    }

    @media (max-width: 768px) {
      body {
        padding-top: 50px;
      }
      
      header {
        height: 120px;
      }

      #chat-container {
        height: calc(100vh - 230px);
        padding-top: 10px;
      }
    }

  </style>
</head>

<body>
  <header>
    <img src="https://drive.google.com/thumbnail?id=19IfUqFyOOBJ5_GNGsBmaXDXEw4I2Njhr" alt="COI Compass Logo"
      class="logo">
    <button class="hamburger" onclick="toggleDriveResults()">☰</button>
    <button id="home-button" class="home-icon" onclick="goHome()" aria-label="ホームに戻る">
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
    <polyline points="9 22 9 12 15 12 15 22"></polyline>
  </svg>
  </header>

  <div id="chat-container">
    <div id="welcome-message">ようこそCOICompassへ！<br>調べたい国を選んでください</div>
    <div id="country-selection">
      <button onclick="handleCountrySelection('Uganda')">Uganda</button>
      <button onclick="handleCountrySelection('Sri Lanka')">Sri Lanka</button>
      <button onclick="handleCountrySelection('Nigeria')">Nigeria</button>
      <button id="coi-concept-button" onclick="openCOIConcept()">COIの考え方</button>
    </div>
  </div>

  <div id="input-area">
    <input type="text" id="user-input" placeholder="質問を入力してください">
    <button id="send-button" onclick="sendMessage()">送信</button>
  </div>

  <div id="drive-results"></div>

<script>
    var selectedCountry = '';
    let coiConceptDisplayed = false;

    const topics = {
      'Uganda': ['政治的発言', 'ジェンダー']
    };

    function handleCountrySelection(country) {
      selectedCountry = country;
      hideWelcomeAndButtons();
      addMessageToChat('bot', `${country}について知りたいことを選んでください。`);
      if (country === 'Uganda') {
        showTopicOptions(country);
      }
    }

    function hideWelcomeAndButtons() {
      document.getElementById('country-selection').style.display = 'none';
      document.getElementById('welcome-message').style.display = 'none';
      document.getElementById('input-area').style.display = 'flex';
      document.getElementById('chat-container').style.paddingBottom = '100px';
    }

    function openCOIConcept() {
      if (coiConceptDisplayed) return;

      var button = document.getElementById('coi-concept-button');
      button.disabled = true;
      button.textContent = 'Loading...';

      google.script.run
        .withSuccessHandler(function(content) {
          hideWelcomeAndButtons();
          addMessageToChat('bot', content, true, false);
          coiConceptDisplayed = true;
          resetCOIConceptButton();
        })
        .withFailureHandler(function(error) {
          console.error('Error:', error);
          addMessageToChat('bot', 'COIの考え方の取得中にエラーが発生しました。');
          resetCOIConceptButton();
        })
        .getCOIConceptContent();
    }

    function addMessageToChat(sender, message, appendButtons = false, shouldScroll = true) {
      var chatContainer = document.getElementById('chat-container');
      var messageElement = document.createElement('div');
      messageElement.className = 'message ' + (sender === 'user' ? 'user-message' : 'bot-message');
      
      var paragraphs = message.split('\n');
      paragraphs.forEach(function(paragraph) {
        var p = document.createElement('p');
        p.textContent = paragraph;
        messageElement.appendChild(p);
      });

      chatContainer.appendChild(messageElement);
      
      if (appendButtons) {
        appendButtonsAfterContent(messageElement);
      }

      if (shouldScroll) {
        setTimeout(() => {
          messageElement.scrollIntoView({ behavior: 'smooth', block: 'end' });
        }, 100);
      }
    }

    function appendButtonsAfterContent(messageElement) {
      var buttonsContainer = document.createElement('div');
      buttonsContainer.id = 'country-selection';
      buttonsContainer.style.display = 'flex';
      buttonsContainer.style.flexDirection = 'column';
      buttonsContainer.style.gap = '20px';
      buttonsContainer.style.width = '50%';
      buttonsContainer.style.margin = '20px auto 0';

      var countries = ['Uganda', 'Sri Lanka', 'Nigeria'];
      countries.forEach(function(country) {
        var button = document.createElement('button');
        button.textContent = country;
        button.onclick = function() { handleCountrySelection(country); };
        buttonsContainer.appendChild(button);
      });

      var coiButton = document.createElement('button');
      coiButton.textContent = 'COIの考え方';
      coiButton.id = 'coi-concept-button';
      coiButton.onclick = openCOIConcept;
      buttonsContainer.appendChild(coiButton);

      messageElement.appendChild(buttonsContainer);
    }

    function resetCOIConceptButton() {
      var button = document.getElementById('coi-concept-button');
      button.disabled = false;
      button.textContent = 'COIの考え方';
    }

    function sendMessage() {
      var userInput = document.getElementById('user-input');
      var message = userInput.value;
      if (message.trim() === '') return;
      addMessageToChat('user', message);
      userInput.value = '';
      google.script.run.withSuccessHandler(handleResponse).handleUserInput(selectedCountry, message);
    }

    function handleResponse(result) {
      addMessageToChat('bot', result.difyResponse);
      displayDriveResults(result.driveResults);
    }

    function displayDriveResults(results) {
      var container = document.getElementById('drive-results');
      container.innerHTML = '<h3>関連する文書:</h3>';
      if (results.length === 0) {
        container.innerHTML += '<p>関連する文書は見つかりませんでした。</p>';
        return;
      }
      results.forEach(function(file) {
        container.innerHTML += `
          <div>
            <strong>${file.name}</strong><br>
            <a href="${file.url}" target="_blank">ドキュメントを開く</a><br>
            <em>${file.snippet}</em>
          </div>
        `;
      });
    }

    function toggleDriveResults() {
      var driveResults = document.getElementById('drive-results');
      driveResults.style.display = driveResults.style.display === 'none' ? 'block' : 'none';
    }

 function goHome() {
    selectedCountry = '';
    coiConceptDisplayed = false;
    document.getElementById('country-selection').style.display = 'flex';
    document.getElementById('welcome-message').style.display = 'block';
    document.getElementById('input-area').style.display = 'none';
    document.getElementById('chat-container').innerHTML = `
      <div id="welcome-message">ようこそCOICompassへ！<br>調べたい国を選んでください</div>
      <div id="country-selection">
        <button onclick="handleCountrySelection('Uganda')">Uganda</button>
        <button onclick="handleCountrySelection('Sri Lanka')">Sri Lanka</button>
        <button onclick="handleCountrySelection('Nigeria')">Nigeria</button>
        <button id="coi-concept-button" onclick="openCOIConcept()">COIの考え方</button>
      </div>
    `;

    // オプション：ユーザーにフィードバックを提供
    console.log("ホーム画面に戻りました");
    // あるいは、画面上に通知を表示する場合:
    // showNotification("ホーム画面に戻りました");
  }

  // オプション：通知を表示する関数
  function showNotification(message) {
    const notification = document.createElement('div');
    notification.textContent = message;
    notification.style.position = 'fixed';
    notification.style.top = '20px';
    notification.style.left = '50%';
    notification.style.transform = 'translateX(-50%)';
    notification.style.backgroundColor = '#4CAF50';
    notification.style.color = 'white';
    notification.style.padding = '10px';
    notification.style.borderRadius = '5px';
    notification.style.zIndex = '1000';
    document.body.appendChild(notification);

    setTimeout(() => {
      document.body.removeChild(notification);
    }, 3000);
  }
  
      function showTopicOptions(country) {
      const optionsContainer = document.createElement('div');
      optionsContainer.id = 'topic-options';
      
      topics[country].forEach(topic => {
        const button = document.createElement('button');
        button.textContent = topic;
        button.onclick = () => handleTopicSelection(country, topic);
        optionsContainer.appendChild(button);
      });
      
      document.getElementById('chat-container').appendChild(optionsContainer);
    }

    function handleTopicSelection(country, topic) {
      addMessageToChat('user', `${country}/${topic}`);
      google.script.run
        .withSuccessHandler(handleTopicResponse)
        .withFailureHandler(handleError)
        .handleUserInput(country, `${country}/${topic}`);
    }

    function handleTopicResponse(result) {
      if (result.success) {
        addMessageToChat('bot', result.message);
        addMessageToChat('bot', result.content);
      } else {
        addMessageToChat('bot', result.message);
      }
    }

    function handleError(error) {
      console.error('Error:', error);
      addMessageToChat('bot', 'エラーが発生しました。もう一度お試しください。');
    }

    document.getElementById('user-input').addEventListener('keydown', function(e) {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    document.getElementById('coi-concept-button').addEventListener('click', function() {
      if (this.disabled || coiConceptDisplayed) return;
      openCOIConcept();
    });

    
</script>

</body>
</html>