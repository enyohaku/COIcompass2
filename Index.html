<!DOCTYPE html>
<html lang="ja">

<head>

  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>COI Compass</title>
    <base target="_top">
    <style>
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
        -webkit-tap-highlight-color: transparent;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        line-height: 1.6;
        color: #333;
        background-color: #f0f0f0;
        height: 100vh;
        overflow: hidden;
        font-size: 36px;
        padding-top: 120px;
        /* ãƒ˜ãƒƒãƒ€ãƒ¼ã®é«˜ã•åˆ†ã®ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’è¿½åŠ  */
      }

      header {
        background-color: #ffffff;
        padding: 15px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        z-index: 1000;
        height: 120px;
      }

      .logo {
        height: 100px;
      }

      .home-icon {
        font-size: 54px;
        background: none;
        border: none;
        cursor: pointer;
        padding: 10px 15px;
      }

      .home-icon:hover {
        opacity: 0.7;
      }

      .hamburger {
        font-size: 54px;
        background: none;
        border: none;
        cursor: pointer;
        padding: 10px 15px;
      }

      #chat-container {
        height: calc(100vh - 300px);
        /* ãƒ˜ãƒƒãƒ€ãƒ¼ã¨å…¥åŠ›ã‚¨ãƒªã‚¢ã®é«˜ã•ã‚’è€ƒæ…® */
        overflow-y: auto;
        padding: 20px;
        padding-bottom: 180px;
        background-color: #f0f0f0;
        display: flex;
        flex-direction: column;
        -webkit-overflow-scrolling: touch;
      }

      .message {
        max-width: 80%;
        margin-bottom: 20px;
        padding: 15px 20px;
        border-radius: 25px;
        clear: both;
        word-wrap: break-word;
        font-size: 36px;
        line-height: 1.4;
      }

      .user-message {
        background-color: #dcf8c6;
        align-self: flex-end;
        border-bottom-right-radius: 10px;
      }

      .bot-message {
        background-color: #ffffff;
        align-self: flex-start;
        border-bottom-left-radius: 10px;
      }

      #welcome-message {
        text-align: center;
        margin: 20px 0;
        /* ãƒãƒ¼ã‚¸ãƒ³ã‚’èª¿æ•´ */
        font-size: 44px;
        font-weight: bold;
        color: #4a4a4a;
      }

      #country-selection {
        display: flex;
        flex-direction: column;
        gap: 20px;
        width: 50%;
        margin: 0 auto;
        padding: 0 20px;
      }

      #country-selection button {
        width: 100%;
        padding: 20px;
        background-color: #4CAF50;
        color: white;
        border: none;
        border-radius: 15px;
        cursor: pointer;
        transition: background-color 0.3s, transform 0.1s;
        font-size: 40px;
        font-weight: bold;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      }

      /* ã€Œï¼ˆå›½åï¼‰ã«ã¤ã„ã¦ä½•ãŒçŸ¥ã‚ŠãŸã„ã§ã™ã‹ï¼Ÿã€ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’10pxä¸‹ã«ä¸‹ã’ã‚‹ */
      .country-question {
        margin-top: 10px;
      }

      /* å…¥åŠ›æ¬„ã¨é€ä¿¡ãƒœã‚¿ãƒ³ã‚’ä¸Šä¸‹ä¸­å¤®ã«æƒãˆã‚‹ */
      #input-area {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background-color: #ffffff;
        padding: 15px;
        display: flex;
        align-items: center;
        box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.1);
        height: 180px;
      }

      #user-input {
        flex: 1;
        padding: 30px 20px;
        border: 3px solid #000080;
        border-radius: 40px;
        font-size: 48px;
        outline: none;
        margin-right: 10px;
      }

      #send-button {
        width: 130px;
        height: 100px;
        background-color: #4CAF50;
        color: white;
        border: none;
        border-radius: 50px;
        cursor: pointer;
        font-size: 48px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      #drive-results {
        display: none;
        position: fixed;
        top: 90px;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #ffffff;
        padding: 20px;
        overflow-y: auto;
        z-index: 2000;
        font-size: 36px;
      }

      #drive-results h3 {
        margin-bottom: 20px;
        font-size: 40px;
      }

      #drive-results div {
        margin-bottom: 30px;
      }

      #drive-results a {
        color: #4CAF50;
        text-decoration: none;
        font-size: 36px;
      }

      #drive-results em {
        font-style: italic;
        color: #666;
      }

      @media (max-width: 768px) {
        body {
          padding-top: 50px;
          /* å°ã•ãªç”»é¢ã§ã¯ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’èª¿æ•´ */
        }

        .home-icon {
          font-size: 36px;
          padding: 5px 10px;
        }
      }

      header {
        height: 120px;
      }

      #chat-container {
        height: calc(100vh - 230px);
        /* å°ã•ãªç”»é¢ã§ã¯é«˜ã•ã‚’èª¿æ•´ */
        padding-top: 10px;
      }
    </style>
  </head>

<body>
  <header>
    <img src="https://drive.google.com/thumbnail?id=19IfUqFyOOBJ5_GNGsBmaXDXEw4I2Njhr" alt="COI Compass Logo"
      class="logo">
    <!-- <button id="home-button" class="home-icon" aria-label="ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹">ğŸ </button> -->
    <button class="hamburger" onclick="toggleDriveResults()">â˜°</button>
  </header>

  <div id="chat-container">
    <div id="welcome-message">ã‚ˆã†ã“ãCOICompassã¸ï¼<br>èª¿ã¹ãŸã„å›½ã‚’é¸ã‚“ã§ãã ã•ã„</div>
    <div id="country-selection">
      <button onclick="handleCountrySelection('Uganda')">Uganda</button>
      <button onclick="handleCountrySelection('Sri Lanka')">Sri Lanka</button>
      <button onclick="handleCountrySelection('Nigeria')">Nigeria</button>
      <button id="coi-concept-button" onclick="openCOIConcept()">COIã®è€ƒãˆæ–¹</button>
    </div>
  </div>

  <div id="input-area">
    <input type="text" id="user-input" placeholder="è³ªå•ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„">
    <button id="send-button" onclick="sendMessage()">é€ä¿¡</button>
  </div>

  <div id="drive-results"></div>

  <script>
    var selectedCountry = '';
let coiConceptDisplayed = false;

function handleCountrySelection(country) {
  selectedCountry = country;
  hideWelcomeAndButtons();
  addMessageToChat('bot', `${country}ã«ã¤ã„ã¦çŸ¥ã‚ŠãŸã„ã“ã¨ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚`);
}

function hideWelcomeAndButtons() {
  document.getElementById('country-selection').style.display = 'none';
  document.getElementById('welcome-message').style.display = 'none';
  document.getElementById('input-area').style.display = 'flex';
  document.getElementById('chat-container').style.paddingBottom = '100px';
}

function openCOIConcept() {
  if (coiConceptDisplayed) return;

  var button = document.getElementById('coi-concept-button');
  button.disabled = true;
  button.textContent = 'Loading...';

  google.script.run
    .withSuccessHandler(function(content) {
      hideWelcomeAndButtons();
      addMessageToChat('bot', content, true, false); // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã—ãªã„ã‚ˆã†ã«falseã‚’è¿½åŠ 
      coiConceptDisplayed = true;
      resetCOIConceptButton();
    })
    .withFailureHandler(function(error) {
      console.error('Error:', error);
      addMessageToChat('bot', 'COIã®è€ƒãˆæ–¹ã®å–å¾—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
      resetCOIConceptButton();
    })
    .getCOIConceptContent();
}

function addMessageToChat(sender, message, appendButtons = false, shouldScroll = true) {
  var chatContainer = document.getElementById('chat-container');
  var messageElement = document.createElement('div');
  messageElement.className = 'message ' + (sender === 'user' ? 'user-message' : 'bot-message');
  
  var paragraphs = message.split('\n');
  paragraphs.forEach(function(paragraph) {
    var p = document.createElement('p');
    p.textContent = paragraph;
    messageElement.appendChild(p);
  });

  chatContainer.appendChild(messageElement);
  
  if (appendButtons) {
    appendButtonsAfterContent(messageElement);
  }

  if (shouldScroll) {
    setTimeout(() => {
      messageElement.scrollIntoView({ behavior: 'smooth', block: 'end' });
    }, 100);
  }
}

function appendButtonsAfterContent(messageElement) {
  var buttonsContainer = document.createElement('div');
  buttonsContainer.id = 'country-selection';
  buttonsContainer.style.display = 'flex';
  buttonsContainer.style.flexDirection = 'column';
  buttonsContainer.style.gap = '20px';
  buttonsContainer.style.width = '50%';
  buttonsContainer.style.margin = '20px auto 0';

  var countries = ['Uganda', 'Sri Lanka', 'Nigeria'];
  countries.forEach(function(country) {
    var button = document.createElement('button');
    button.textContent = country;
    button.onclick = function() { handleCountrySelection(country); };
    buttonsContainer.appendChild(button);
  });

  var coiButton = document.createElement('button');
  coiButton.textContent = 'COIã®è€ƒãˆæ–¹';
  coiButton.id = 'coi-concept-button';
  coiButton.onclick = openCOIConcept;
  buttonsContainer.appendChild(coiButton);

  messageElement.appendChild(buttonsContainer);
}

function resetCOIConceptButton() {
  var button = document.getElementById('coi-concept-button');
  button.disabled = false;
  button.textContent = 'COIã®è€ƒãˆæ–¹';
}

function sendMessage() {
  var userInput = document.getElementById('user-input');
  var message = userInput.value;
  if (message.trim() === '') return;
  addMessageToChat('user', message);
  userInput.value = '';
  google.script.run.withSuccessHandler(handleResponse).handleUserInput(selectedCountry, message);
}

function handleResponse(result) {
  addMessageToChat('bot', result.difyResponse);
  displayDriveResults(result.driveResults);
}

document.getElementById('user-input').addEventListener('keydown', function(e) {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    sendMessage();
  }
});

// ä»–ã®æ—¢å­˜ã®é–¢æ•°ï¼ˆdisplayDriveResults, toggleDriveResults ãªã©ï¼‰ã¯ãã®ã¾ã¾ã§å¤§ä¸ˆå¤«ã§ã™
  function displayDriveResults(results) {
    var container = document.getElementById('drive-results');
    container.innerHTML = '<h3>é–¢é€£ã™ã‚‹æ–‡æ›¸:</h3>';
    if (results.length === 0) {
      container.innerHTML += '<p>é–¢é€£ã™ã‚‹æ–‡æ›¸ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</p>';
      return;
    }
    results.forEach(function(file) {
      container.innerHTML += `
        <div>
          <strong>${file.name}</strong><br>
          <a href="${file.url}" target="_blank">ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’é–‹ã</a><br>
          <em>${file.snippet}</em>
        </div>
      `;
    });
  }

  function toggleDriveResults() {
    var driveResults = document.getElementById('drive-results');
    driveResults.style.display = driveResults.style.display === 'none' ? 'block' : 'none';
  }

function goHome() {
  selectedCountry = '';
  coiConceptDisplayed = false;
  document.getElementById('country-selection').style.display = 'flex';
  document.getElementById('welcome-message').style.display = 'block';
  document.getElementById('input-area').style.display = 'none';
  document.getElementById('chat-container').innerHTML = `
    <div id="welcome-message">ã‚ˆã†ã“ãCOICompassã¸ï¼<br>èª¿ã¹ãŸã„å›½ã‚’é¸ã‚“ã§ãã ã•ã„</div>
    <div id="country-selection">
      <button onclick="handleCountrySelection('Uganda')">Uganda</button>
      <button onclick="handleCountrySelection('Sri Lanka')">Sri Lanka</button>
      <button onclick="handleCountrySelection('Nigeria')">Nigeria</button>
      <button id="coi-concept-button" onclick="openCOIConcept()">COIã®è€ƒãˆæ–¹</button>
    </div>
  `;
}
  
  document.getElementById('user-input').addEventListener('keydown', function(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  });

  // COIã®è€ƒãˆæ–¹ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’æ›´æ–°
  document.getElementById('coi-concept-button').addEventListener('click', function() {
    if (this.disabled || coiConceptDisplayed) return; // ãƒœã‚¿ãƒ³ãŒç„¡åŠ¹åŒ–ã•ã‚Œã¦ã„ã‚‹ã‹ã€æ—¢ã«è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ä½•ã‚‚ã—ãªã„
    openCOIConcept();
  });

      const topics = {
      'Uganda': ['æ”¿æ²»çš„ç™ºè¨€', 'ã‚¸ã‚§ãƒ³ãƒ€ãƒ¼']
    };

    function handleCountrySelection(country) {
      selectedCountry = country;
      hideWelcomeAndButtons();
      addMessageToChat('bot', `${country}ã«ã¤ã„ã¦çŸ¥ã‚ŠãŸã„ã“ã¨ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚`);
      showTopicOptions(country);
    }

    function showTopicOptions(country) {
      const optionsContainer = document.createElement('div');
      optionsContainer.id = 'topic-options';
      
      topics[country].forEach(topic => {
        const button = document.createElement('button');
        button.textContent = `${country}/${topic}`;
        button.onclick = () => handleTopicSelection(country, topic);
        optionsContainer.appendChild(button);
      });
      
      document.getElementById('chat-container').appendChild(optionsContainer);
    }

    function handleTopicSelection(country, topic) {
      addMessageToChat('user', `${country}/${topic}`);
      google.script.run
        .withSuccessHandler(handleTopicResponse)
        .withFailureHandler(handleError)
        .handleUserInput(country, `${country}/${topic}`);
    }

    function handleTopicResponse(result) {
      if (result.success) {
        addMessageToChat('bot', result.message);
        window.open(result.url, '_blank');
      } else {
        addMessageToChat('bot', result.message);
      }
    }

    function handleError(error) {
      console.error('Error:', error);
      addMessageToChat('bot', 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
    }
  </script>
</body>
</html>