<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>COI Compass</title>
  <base target="_top">
  <style>
    /* CSSは以前と同じ内容を使用 */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      line-height: 1.6;
      color: #333;
      background-color: #f0f0f0;
      height: 100vh;
      overflow: hidden;
      font-size: 36px;
      padding-top: 120px;
    }

    header {
      background-color: #ffffff;
      padding: 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 1000;
      height: 120px;
    }

    .logo {
      height: 100px;
    }

    .header-buttons {
      display: flex;
      align-items: flex-start;
    }

    .header-icon {
      background: none;
      border: none;
      cursor: pointer;
      padding: 10px 15px;
      font-size: 54px;
    }

    .home-icon svg {
      width: 54px;
      height: 54px;
      stroke: #000000;
    }

    .hamburger-icon {
      margin-top: -10px;
    }

    .header-icon:hover {
      opacity: 0.7;
    }

    #chat-container {
      height: calc(100vh - 300px);
      overflow-y: auto;
      padding: 20px;
      padding-bottom: 180px;
      background-color: #f0f0f0;
      display: flex;
      flex-direction: column;
      -webkit-overflow-scrolling: touch;
    }

    .message {
      max-width: 80%;
      margin-bottom: 20px;
      padding: 15px 20px;
      border-radius: 25px;
      clear: both;
      word-wrap: break-word;
      font-size: 36px;
      line-height: 1.4;
    }

    .user-message {
      background-color: #dcf8c6;
      align-self: flex-end;
      border-bottom-right-radius: 10px;
    }

    .bot-message {
      background-color: #ffffff;
      align-self: flex-start;
      border-bottom-left-radius: 10px;
    }

    #welcome-message {
      text-align: center;
      margin: 20px 0;
      font-size: 44px;
      font-weight: bold;
      color: #4a4a4a;
    }

    #country-selection,
    #uganda-options,
    #topic-options {
      display: flex;
      flex-direction: column;
      gap: 20px;
      width: 50%;
      margin: 20px auto 0;
      padding: 0 20px;
    }

    #country-selection button,
    #uganda-options button,
    #topic-options button {
      width: 100%;
      padding: 20px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 15px;
      cursor: pointer;
      transition: background-color 0.3s, transform 0.1s;
      font-size: 40px;
      font-weight: bold;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }

    #country-selection button:hover,
    #uganda-options button:hover,
    #topic-options button:hover {
      background-color: #45a049;
      transform: scale(1.02);
    }

    #input-area {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background-color: #ffffff;
      padding: 15px;
      display: flex;
      align-items: center;
      box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.1);
      height: 180px;
      display: none;
      /* 初期状態は非表示 */
    }

    #user-input {
      flex: 1;
      padding: 30px 20px;
      border: 3px solid #000080;
      border-radius: 40px;
      font-size: 48px;
      outline: none;
      margin-right: 10px;
    }

    #send-button {
      width: 130px;
      height: 100px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 50px;
      cursor: pointer;
      font-size: 48px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #drive-results {
      display: none;
      position: fixed;
      top: 90px;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ffffff;
      padding: 20px;
      overflow-y: auto;
      z-index: 2000;
      font-size: 36px;
    }

    #drive-results h3 {
      margin-bottom: 20px;
      font-size: 40px;
    }

    #drive-results div {
      margin-bottom: 30px;
    }

    #drive-results a {
      color: #4CAF50;
      text-decoration: none;
      font-size: 36px;
    }

    #drive-results em {
      font-style: italic;
      color: #666;
    }

    @media (max-width: 768px) {
      body {
        padding-top: 50px;
      }

      header {
        height: 120px;
      }

      #chat-container {
        height: calc(100vh - 230px);
        padding-top: 10px;
      }
    }

    #hamburger-menu {
      position: fixed;
      top: 120px;
      right: -300px;
      width: 300px;
      height: calc(100% - 120px);
      background-color: #f8f8f8;
      transition: right 0.3s ease-in-out;
      overflow-y: auto;
      z-index: 999;
    }

    #hamburger-menu.menu-visible {
      right: 0;
    }

    /* 追加: .menu-hidden クラス */
    #hamburger-menu.menu-hidden {
      right: -300px;
    }

    #hamburger-menu nav ul {
      list-style-type: none;
      padding: 0;
    }

    #hamburger-menu nav ul li {
      padding: 15px;
      border-bottom: 1px solid #e0e0e0;
    }

    #hamburger-menu nav ul li a {
      color: #333;
      text-decoration: none;
      font-size: 18px;
    }

    .pdf-container {
      width: 100%;
      margin-top: 20px;
    }

    .pdf-options {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-bottom: 10px;
    }

    .pdf-button {
      display: inline-block;
      padding: 10px 20px;
      background-color: #4CAF50;
      color: white;
      text-decoration: none;
      border-radius: 5px;
      font-size: 16px;
    }

    .pdf-button:hover {
      background-color: #45a049;
    }

    .pdf-embed {
      width: 100%;
      height: 600px;
      border: 1px solid #ccc;
    }

    .viewer-container {
      width: 100%;
      margin-top: 20px;
    }

    .view-options {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-bottom: 10px;
    }

    .view-button {
      display: inline-block;
      padding: 10px 20px;
      background-color: #4CAF50;
      color: white;
      text-decoration: none;
      border-radius: 5px;
      font-size: 16px;
      cursor: pointer;
      border: none;
    }

    .view-button:hover {
      background-color: #45a049;
    }

    .view-content {
      width: 100%;
      height: 600px;
      border: 1px solid #ccc;
      overflow-y: auto;
    }

    .text-content {
      padding: 20px;
      font-size: 16px;
      line-height: 1.6;
    }

    .coi-concept-content {
      background-color: #ffffff;
      border-radius: 10px;
      padding: 20px;
      margin-top: 20px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    .coi-concept-content h2 {
      font-size: 24px;
      margin-bottom: 15px;
    }

    .content-options {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
    }

    .content-button {
      display: inline-block;
      padding: 10px 15px;
      background-color: #4CAF50;
      color: white;
      text-decoration: none;
      border-radius: 5px;
      font-size: 16px;
    }

    .content-button:hover {
      background-color: #45a049;
    }

    .pdf-notice {
      margin-top: 15px;
      font-style: italic;
      color: #666;
    }

    .dark-theme {
      background-color: #333;
      color: #f0f0f0;
    }

    .dark-theme .message {
      background-color: #444;
    }

    .dark-theme .user-message {
      background-color: #2a5d2a;
    }

    .dark-theme .bot-message {
      background-color: #444;
    }

    .dark-theme #input-area {
      background-color: #222;
    }

    .dark-theme #user-input {
      background-color: #444;
      color: #f0f0f0;
      border-color: #666;
    }

    .dark-theme #send-button {
      background-color: #4CAF50;
    }

    .dark-theme #hamburger-menu {
      background-color: #222;
    }

    .dark-theme #hamburger-menu nav ul li a {
      color: #f0f0f0;
    }
  </style>
</head>

<body>
  <header>
    <img src="https://drive.google.com/thumbnail?id=19IfUqFyOOBJ5_GNGsBmaXDXEw4I2Njhr" alt="COI Compass Logo" class="logo">
    <div class="header-buttons">
      <button id="home-button" class="header-icon home-icon" aria-label="ホームに戻る">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
          <polyline points="9 22 9 12 15 12 15 22"></polyline>
        </svg>
      </button>
      <button id="hamburger-button" class="header-icon hamburger-icon" aria-label="メニューを開く">☰</button>
    </div>
  </header>
  <div id="hamburger-menu" class="menu-hidden">
    <nav>
      <ul>
        <li><a href="#about-coi-compass">COICompassとは</a></li>
        <li><a href="#how-to-use">使い方</a></li>
        <li><a href="#toggle-theme">テーマ切り替え</a></li>
        <li><a href="#increase-font-size">表示文字を大きくする</a></li>
        <li><a href="https://forms.gle/2rVipVMNrXmdoZk6A" target="_blank">利用者アンケート</a></li>
      </ul>
    </nav>
  </div>
  <div id="chat-container">
    <div id="welcome-message">ようこそCOICompassへ！<br>調べたい国を選んでください</div>
    <div id="country-selection">
      <button class="country-button" data-country="Uganda">Uganda ウガンダ</button>
      <button class="country-button" data-country="Sri Lanka">Sri Lanka スリランカ</button>
      <button class="country-button" data-country="Nigeria">Nigeria ナイジェリア</button>
      <button class="country-button" data-country="Cameroon">Cameroon カメルーン</button>
      <button class="country-button" data-country="Cambodia">Cambodia カンボジア</button>
      <button id="coi-concept-button">COI（出身国情報）について</button>
    </div>
  </div>

  <div id="input-area">
    <input type="text" id="user-input" placeholder="質問を入力してください">
    <button id="send-button">送信</button>
  </div>

  <div id="drive-results"></div>

  <script>
    console.log("Script loaded");

    var selectedCountry = '';
    let coiConceptDisplayed = false;

    const topics = {
      'Uganda': ['政治的発言', 'ジェンダー'],
      'Sri Lanka': ['政治的発言', 'ジェンダー'],
      'Nigeria': ['政治的発言', 'ジェンダー'],
      'Cameroon': ['政治的発言', 'ジェンダー'],
      'Cambodia': ['政治的発言', 'ジェンダー']
    };

    // イベントリスナーの設定
    document.getElementById('home-button').addEventListener('click', goHome);
    document.getElementById('hamburger-button').addEventListener('click', toggleHamburgerMenu);
    document.getElementById('send-button').addEventListener('click', sendMessage);
    document.getElementById('coi-concept-button').addEventListener('click', function () {
      if (this.disabled || coiConceptDisplayed) return;
      openCOIConcept();
    });

    // 国選択ボタンのイベントリスナー
    document.querySelectorAll('.country-button').forEach(button => {
      button.addEventListener('click', function () {
        handleCountrySelection(this.getAttribute('data-country'));
      });
    });

    function handleCountrySelection(country) {
      selectedCountry = country;
      hideWelcomeAndButtons();
      addMessageToChat('bot', `${country}について知りたいことを選んでください。`);
      showTopicOptions(country);
    }

    function goHome() {
      selectedCountry = '';
      coiConceptDisplayed = false;
      document.getElementById('country-selection').style.display = 'flex';
      document.getElementById('welcome-message').style.display = 'block';
      document.getElementById('input-area').style.display = 'flex';

      // プレースホルダーテキストを変更
  document.getElementById('user-input').placeholder = '国を選択してください';

      document.getElementById('chat-container').innerHTML = `
        <div id="welcome-message">ようこそCOICompassへ！<br>調べたい国を選んでください</div>
        <div id="country-selection">
          <button class="country-button" data-country="Uganda">Uganda ウガンダ</button>
          <button class="country-button" data-country="Sri Lanka">Sri Lanka スリランカ</button>
          <button class="country-button" data-country="Nigeria">Nigeria ナイジェリア</button>
          <button class="country-button" data-country="Cameroon">Cameroon カメルーン</button>
          <button class="country-button" data-country="Cambodia">Cambodia カンボジア</button>
          <button id="coi-concept-button">COI（出身国情報）について</button>
        </div>
      `;
// 新しく生成されたボタンにイベントリスナーを再設定
  document.querySelectorAll('.country-button').forEach(button => {
    button.addEventListener('click', function () {
      handleCountrySelection(this.getAttribute('data-country'));
    });
  });
  document.getElementById('coi-concept-button').addEventListener('click', function () {
    if (this.disabled || coiConceptDisplayed) return;
    openCOIConcept();
  });
  console.log("ホーム画面に戻りました");
}
    function hideWelcomeAndButtons() {
      document.getElementById('country-selection').style.display = 'none';
      document.getElementById('welcome-message').style.display = 'none';
      document.getElementById('input-area').style.display = 'flex';
      document.getElementById('chat-container').style.paddingBottom = '100px';
    }

    function showTopicOptions(country) {
      const topicList = topics[country];  // 選択された国に対応するトピックを取得

      if (topicList) {
        let message = `${country}に関する以下のトピックから選んでください:\n`;
        topicList.forEach((topic, index) => {
          message += `${index + 1}. ${topic}\n`;  // トピックを番号付きでリスト表示
        });
        addMessageToChat('bot', message);  // チャットにトピックを表示
      } else {
        addMessageToChat('bot', 'この国に関するトピックはまだ登録されていません。');
      }
    }

    function addMessageToChat(sender, message, appendButtons = false, shouldScroll = true) {
      var chatContainer = document.getElementById('chat-container');
      var messageElement = document.createElement('div');
      messageElement.className = 'message ' + (sender === 'user' ? 'user-message' : 'bot-message');

      var paragraphs = message.split('\n');
      paragraphs.forEach(function (paragraph) {
        var p = document.createElement('p');
        p.textContent = paragraph;
        messageElement.appendChild(p);
      });

      chatContainer.appendChild(messageElement);

      if (appendButtons) {
        appendButtonsAfterContent(messageElement);
      }

      if (shouldScroll) {
        setTimeout(() => {
          messageElement.scrollIntoView({ behavior: 'smooth', block: 'end' });
        }, 100);
      }
    }

    function appendButtonsAfterContent(messageElement) {
      var buttonsContainer = document.createElement('div');
      buttonsContainer.className = 'country-selection'; // クラス名に変更
      buttonsContainer.style.display = 'flex';
      buttonsContainer.style.flexDirection = 'column';
      buttonsContainer.style.gap = '20px';
      buttonsContainer.style.width = '50%';
      buttonsContainer.style.margin = '20px auto 0';

      var countries = ['Uganda', 'Sri Lanka', 'Nigeria'];
      countries.forEach(function (country) {
        var button = document.createElement('button');
        button.textContent = country;
        button.className = 'country-button'; // クラス名追加
        button.setAttribute('data-country', country);
        button.addEventListener('click', function () { handleCountrySelection(country); });
        buttonsContainer.appendChild(button);
      });

      var coiButton = document.createElement('button');
      coiButton.textContent = 'COIの考え方';
      coiButton.id = 'coi-concept-button';
      coiButton.addEventListener('click', function () {
        if (this.disabled || coiConceptDisplayed) return;
        openCOIConcept();
      });
      buttonsContainer.appendChild(coiButton);

      messageElement.appendChild(buttonsContainer);
    }

    function resetCOIConceptButton() {
      var button = document.getElementById('coi-concept-button');
      if (button) {
        button.disabled = false;
        button.textContent = 'COIの考え方';
      }
    }

    function openCOIConcept() {
      if (coiConceptDisplayed) return;

      var button = document.getElementById('coi-concept-button');
      if (!button) return;

      button.disabled = true;
      button.textContent = 'Loading...';

      google.script.run
        .withSuccessHandler(function (result) {
          console.log('getCOIConceptContent result:', result);  // ログを追加
          hideWelcomeAndButtons();
          if (result.success) {
            displayCOIConceptContent(result);
          } else {
            addMessageToChat('bot', result.message);
          }
          coiConceptDisplayed = true;
          resetCOIConceptButton();
        })
        .withFailureHandler(function (error) {
          console.error('Error in openCOIConcept:', error);
          addMessageToChat('bot', 'COIの考え方の取得中にエラーが発生しました: ' + error.message);
          resetCOIConceptButton();
        })
        .getCOIConceptContent();
    }

    function displayCOIConceptContent(result) {
      var chatContainer = document.getElementById('chat-container');
      var contentContainer = document.createElement('div');
      contentContainer.className = 'coi-concept-content';
      contentContainer.innerHTML = `
        <h2>${result.name}</h2>
        <p>ファイルサイズ: ${formatFileSize(result.size)}</p>
        <p>最終更新日: ${result.lastUpdated}</p>
        <div class="content-options">
          <a href="${result.webViewLink}" target="_blank" class="content-button">Google Driveで開く</a>
          <a href="${result.url}" class="content-button">PDFをダウンロード</a>
        </div>
        <p class="pdf-notice">PDFの内容はリンクから直接ご覧ください。</p>
      `;
      chatContainer.appendChild(contentContainer);

      // スクロールして新しいコンテンツを表示
      contentContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    function formatFileSize(bytes) {
      if (bytes < 1024) return bytes + ' bytes';
      else if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
      else return (bytes / 1048576).toFixed(1) + ' MB';
    }

    function toggleView(viewType) {
      var pdfView = document.getElementById('pdf-view');
      var textView = document.getElementById('text-view');
      if (pdfView && textView) {
        pdfView.style.display = viewType === 'pdf' ? 'block' : 'none';
        textView.style.display = viewType === 'text' ? 'block' : 'none';
      }
    }

    function sendMessage() {
      var userInput = document.getElementById('user-input');
      var message = userInput.value;
      if (message.trim() === '') return;
      addMessageToChat('user', message);
      userInput.value = '';
      google.script.run.withSuccessHandler(handleResponse).handleUserInput(selectedCountry, message);
    }

    function handleResponse(result) {
      addMessageToChat('bot', result.difyResponse);
      displayDriveResults(result.driveResults);
    }

    function displayDriveResults(results) {
      var container = document.getElementById('drive-results');
      container.innerHTML = '<h3>関連する文書:</h3>';
      if (results.length === 0) {
        container.innerHTML += '<p>関連する文書は見つかりませんでした。</p>';
        return;
      }
      results.forEach(function (file) {
        container.innerHTML += `
          <div>
            <strong>${file.name}</strong><br>
            <a href="${file.url}" target="_blank">ドキュメントを開く</a><br>
            <em>${file.snippet}</em>
          </div>
        `;
      });
    }

    function toggleDriveResults() {
      var driveResults = document.getElementById('drive-results');
      driveResults.style.display = driveResults.style.display === 'none' ? 'block' : 'none';
    }

    function handleMenuItemClick(event) {
      event.preventDefault();
      const targetSection = this.getAttribute('href').substring(1);
      console.log(`Navigating to ${targetSection}`);
      toggleHamburgerMenu();
      // 各セクションに対する処理を追加
      switch (targetSection) {
        case 'about-coi-compass':
          showAboutCOICompass();
          break;
        case 'how-to-use':
          showHowToUse();
          break;
        case 'toggle-theme':
          toggleTheme();
          break;
        case 'increase-font-size':
          increaseFontSize();
          break;
      }
    }

    function showAboutCOICompass() {
      addMessageToChat('bot', 'COICompassは、特定の国の状況に関する情報を提供するツールです。');
    }

    function showHowToUse() {
      addMessageToChat('bot', 'COICompassの使い方：1. 国を選択 2. トピックを選択 3. 質問を入力');
    }

    function toggleTheme() {
      document.body.classList.toggle('dark-theme');
    }

    function increaseFontSize() {
      document.body.style.fontSize = parseInt(getComputedStyle(document.body).fontSize) + 2 + 'px';
    }

    // イベントリスナーの追加（重複を削除）
    document.querySelectorAll('#hamburger-menu a').forEach(item => {
      item.addEventListener('click', handleMenuItemClick);
    });

    // オプション：通知を表示する関数
    function showNotification(message) {
      const notification = document.createElement('div');
      notification.textContent = message;
      notification.style.position = 'fixed';
      notification.style.top = '20px';
      notification.style.left = '50%';
      notification.style.transform = 'translateX(-50%)';
      notification.style.backgroundColor = '#4CAF50';
      notification.style.color = 'white';
      notification.style.padding = '10px';
      notification.style.borderRadius = '5px';
      notification.style.zIndex = '1000';
      document.body.appendChild(notification);

      setTimeout(() => {
        document.body.removeChild(notification);
      }, 3000);
    }

    function handleTopicSelection(country, topic) {
      addMessageToChat('user', `${country}/${topic}`);
      google.script.run
        .withSuccessHandler(handleTopicResponse)
        .withFailureHandler(handleError)
        .handleUserInput(country, `${country}/${topic}`);
    }

    function handleTopicResponse(result) {
      if (result.success) {
        addMessageToChat('bot', result.message);
        addMessageToChat('bot', result.content);
      } else {
        addMessageToChat('bot', result.message);
      }
    }

    function handleError(error) {
      console.error('Error:', error);
      addMessageToChat('bot', 'エラーが発生しました。もう一度お試しください。');
    }

    // Keydown event for 'user-input'
    document.getElementById('user-input').addEventListener('keydown', function (event) {
      if (event.key === 'Enter' && !event.isComposing && !event.shiftKey) {
        event.preventDefault();
        sendMessage();
      }
    });

    function toggleHamburgerMenu() {
      const menu = document.getElementById('hamburger-menu');
      menu.classList.toggle('menu-visible');
      menu.classList.toggle('menu-hidden');
    }
  </script>
</body>

</html>